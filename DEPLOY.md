# Инструкция по развертыванию системы

---

### 1) Сборка образа API
Для сборки Docker-образа REST API необходимо выполнить команду:
```bash
docker build -f ./backend/docker/prod/Dockerfile -t mig-api .
```

---

### 2) Запуск без домена
Если у вас нет еще доменного имени, то получить SSL сертификат никак не получится,
так как для получения сертификата используется cetrtbot от Let'sEncrypt, 
а для выдачи сертификата с его помощью должна произойти проверка домена (DV).  

Запускать будем при помощи файла ```compose-local.yaml```.  
Так же эти действия все можно проделать и на персональном компьютере.

Для начала установим плагин для Loki, чтобы можно было собирать логи:
```bash
docker plugin install grafana/loki-docker-driver:2.9.8 --alias loki --grant-all-permissions
```

В терминале запускаем команду:
```bash
docker compose -f compose-local.yaml up -d
```
Как только увидим, что все контейнеры запущены, через несколько секунд проверяем
их состояние
```bash
docker ps
```
Проверяем, что контейнеры работают.  
Далее проверим состояние API. Можно глянуть логи 
```bash
docker logs -f app
```
Где app имя контейнера API-шки.
А можно сделать запрос на актуатор Spring.
```bash
curl localhost/actuator/health
```
Если пришел ответ ```{"status":"UP"}```, то все хорошо, если же ```{"status":"DOWN"}```,
то что-то не так, если же ответа вовсе не последовало, или пришла 502-я ошибка от nginx,
следует проверить маппинг томов, или очистить их командой:
```bash
docker volume prune
```
или
```bash
docker volume rm <имя тома>
```
Только надо быть осторожным и не удалить нужные тома

---

### 3) Запуск на сервере с доменным именем
Чтобы развернуть информационную систему на сервере при наличии доменного имени, необходимо:
1. Запустить скрипт развертывания  
    ```bash
    sudo bash ./deploy.sh <путь до .env файла>
    ```

   Скрипт развернет приложение и настроит график обновления сертификатов и создания бэкапов.


2. Проверка работоспособности системы  
   Тут все аналогично варианту на локальной машине.

   Как только увидим, что все контейнеры запущены, через несколько секунд проверяем
   их состояние
   ```bash
   docker ps
   ```
   Проверяем, что контейнеры работают.  
   Далее проверим состояние API. Можно глянуть логи
   ```bash
   docker logs -f app
   ```
   Где app имя контейнера API-шки.
   А можно сделать запрос на актуатор Spring.
   ```bash
   curl <домен>/actuator/health
   ```
   Если пришел ответ ```{"status":"UP"}```, то все хорошо, если же ```{"status":"DOWN"}```,
   то что-то не так, если же ответа вовсе не последовало, или пришла 502-я ошибка от nginx,
   следует проверить маппинг томов, или очистить их командой:
   ```bash
   docker volume prune
   ```
   или
   ```bash
   docker volume rm <имя тома>
   ```
   Только надо быть осторожным и не удалить нужные тома